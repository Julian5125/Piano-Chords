<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>iPad Piano Trainer (Ultraâ€‘Compact)</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <style>
    :root {
      --bg: #0f1220;
      --panel: #171b2e;
      --accent: #6ea8fe;
      --accent-2: #9df0c1;
      --text: #e8ecff;
      --muted: #9aa3b2;
      --key-white: #ffffff;
      --key-black: #121212;
      --key-border: #222;
      --key-highlight: #ffdd57;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { touch-action: manipulation; }
    /* Prevent selection/callout on interactive UI */
    .app, .panel, .controls, .btn, .pill, .keyboard, .white-keys, .black-keys, .key { -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; }
    html, body { height: 100%; }
    body { margin: 0; background: radial-gradient(1200px 800px at 40% 0%, #141834, #0b0e1d 70%); color: var(--text); font: 16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }

    .app { max-width: 1100px; margin: 0 auto; padding: env(safe-area-inset-top) 12px env(safe-area-inset-bottom); }
    header { display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap: wrap; }
    header h1 { font-size: clamp(18px, 2.6vw, 26px); font-weight: 700; margin: 6px 0; letter-spacing: 0.2px; }

    .controls { background: color-mix(in oklab, var(--panel), black 10%); border: 1px solid #252a44; padding: 10px; border-radius: 14px; display:flex; flex-wrap:wrap; gap: 10px; align-items: center; box-shadow: 0 10px 30px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.02); }
    .controls .group { display:flex; align-items:center; gap:8px; flex-wrap: wrap; }

    .pill { padding: 8px 12px; border: 1px solid #2b3155; background: #1a1f36; color: var(--text); border-radius: 999px; cursor: pointer; user-select: none; }
    .pill[aria-pressed="true"] { background: #243059; border-color: #3b4aa8; box-shadow: 0 0 0 2px rgba(110,168,254,.15) inset; }

    .btn { appearance:none; border: 1px solid #2c3258; background: linear-gradient(#232844, #1a1f36); color: var(--text); padding: 8px 12px; border-radius: 10px; cursor: pointer; font-weight: 600; letter-spacing:.2px; box-shadow: 0 6px 18px rgba(0,0,0,.3), inset 0 1px 0 rgba(255,255,255,.03); }
    .btn:hover { filter: brightness(1.08); }
    .btn:active { transform: translateY(1px); }

    /* Prominent New Chord button */
    #newChord { padding: 10px 16px; font-size: 16px; border-radius: 12px; background: linear-gradient(180deg, #5ea0ff, #2d66ff); border-color: #2d66ff; color: white; box-shadow: 0 6px 16px rgba(45,102,255,.45), 0 0 0 2px rgba(94,160,255,.2) inset; }
    #newChord:hover { filter: brightness(1.06); }

    .range { display:flex; align-items:center; gap:8px; }
    .range input[type=range] { width: 140px; accent-color: var(--accent); }
    .label { color: var(--muted); font-size: 13px; }

    .panel { margin-top: 10px; padding: 10px; background: color-mix(in oklab, var(--panel), black 6%); border: 1px solid #252a44; border-radius: 14px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }

    .prompt { display:flex; align-items:center; justify-content:space-between; gap:10px; padding: 8px 10px; background: #151a2b; border:1px solid #202645; border-radius: 12px; margin-bottom: 8px; }
    .prompt .chord { font-size: clamp(18px, 3.6vw, 24px); font-weight: 800; letter-spacing:.3px; }
    .prompt .timer { font-variant-numeric: tabular-nums; color: var(--accent-2); font-weight: 700; }

    .keyboards { display:flex; flex-direction: column; gap: 6px; }

    /* ULTRAâ€‘COMPACT KEYBOARDS */
    .keyboard { position: relative; width: 100%; max-width: 100%; aspect-ratio: 8 / 2.2; background: #0b0e15; border-radius: 12px; border: 1px solid #232947; overflow: hidden; box-shadow: inset 0 1px 0 rgba(255,255,255,.02); }

    .white-keys { position:absolute; inset:6px; display:flex; gap: 2px; }
    .key.white { flex:1; background: var(--key-white); border: 1px solid var(--key-border); border-radius: 5px; position:relative; box-shadow: inset 0 -2px 0 rgba(0,0,0,.22); }

    /* DRAW OVER BLACK KEYS: disable pointer-events on black keys and raise canvas above */
    .black-keys { position:absolute; left:6px; right:6px; top:6px; bottom:45%; pointer-events: none; }
    .black-keys .key.black { position:absolute; width: calc((100% - 0px) / 8 * 0.6); height: 100%; background: linear-gradient(#1a1a1a, #0b0b0b); border: 1px solid #000; border-radius: 4px; box-shadow: inset 0 -2px 0 rgba(255,255,255,.08), 0 4px 10px rgba(0,0,0,.55); z-index: 2; }

    /* No printed labels on keys */
    .key-label { display:none; }

    .key.highlight { outline: 3px solid var(--key-highlight); box-shadow: 0 0 0 3px rgba(255,221,87,.25), inset 0 -2px 0 rgba(0,0,0,.22); }
    .key.black.highlight { outline-color: #ffd54a; }

    .draw-wrap { position:absolute; inset:0; pointer-events: none; z-index: 5; }
    canvas.drawing { position:absolute; inset:0; pointer-events:auto; touch-action: none; -webkit-user-select: none; user-select: none; }

    .mode-tag { font-size: 12px; color: var(--muted); }

    .bubble { position:absolute; top:6px; left:50%; transform: translateX(-50%); background: #11162d; color: #dfe7ff; border: 1px solid #2b3566; padding: 2px 6px; border-radius: 999px; font-size: 11px; font-weight: 700; box-shadow: 0 4px 12px rgba(0,0,0,.25); pointer-events: none; }

    @media (orientation:portrait) {
      .keyboard { aspect-ratio: 8 / 3.4; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>ðŸŽ¹ iPad Piano Trainer</h1>
      <div class="controls" role="toolbar" aria-label="Controls">
        <div class="group" id="modeGroup">
          <button class="pill" id="modePractice" aria-pressed="true" title="Practice mode: write the chord notes, then reveal">Practice</button>
          <button class="pill" id="modeFreeDraw" aria-pressed="false" title="Free draw on the keyboard with Apple Pencil">Freeâ€‘draw</button>
          <span class="mode-tag" id="modeHint">Write the three note names on the bottom keyboard.</span>
        </div>
        <div class="group">
          <button class="btn" id="newChord">New chord</button>
          <button class="btn" id="showAnswer">Show answer</button>
          <button class="btn" id="clearInk">Clear</button>
        </div>
        <div class="group range">
          <label class="label" for="waitSeconds">Reveal in</label>
          <input id="waitSeconds" type="range" min="1" max="20" value="7" />
          <span class="label"><span id="waitVal">7</span>s</span>
        </div>
        <div class="group" id="types">
          <span class="label">Chord types:</span>
          <label><input type="checkbox" value="maj" checked> Maj</label>
          <label><input type="checkbox" value="min" checked> Min</label>
          <label><input type="checkbox" value="dim"> Dim</label>
          <label><input type="checkbox" value="aug"> Aug</label>
        </div>
      </div>
    </header>

    <section class="panel">
      <div class="prompt" aria-live="polite">
        <div>
          <div class="label">Chord</div>
          <div class="chord" id="chordName">â€”</div>
        </div>
        <div>
          <div class="label">Autoâ€‘reveal</div>
          <div class="timer" id="countdown">â€”</div>
        </div>
      </div>

      <div class="keyboards">
        <div class="keyboard" id="kbTop" aria-label="Answer keyboard">
          <div class="white-keys" id="topWhite"></div>
          <div class="black-keys" id="topBlack"></div>
        </div>
        <div class="keyboard" id="kbBottom" aria-label="Writing keyboard">
          <div class="white-keys" id="bottomWhite"></div>
          <div class="black-keys" id="bottomBlack"></div>
          <div class="draw-wrap"><canvas class="drawing" id="draw"></canvas></div>
        </div>
      </div>
    </section>
  </div>

  <script>
    // --- Constants & Utilities ---
    const NOTE_NAMES = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"]; // 12
    const CHORDS = { maj:{name:"maj",intervals:[0,4,7]}, min:{name:"min",intervals:[0,3,7]}, dim:{name:"dim",intervals:[0,3,6]}, aug:{name:"aug",intervals:[0,4,8]} };
    const randChoice = (arr) => arr[Math.floor(Math.random() * arr.length)];

    function buildKeyboards() { buildKeyboard("top"); buildKeyboard("bottom"); resizeCanvas(); }

    function buildKeyboard(prefix) {
      const whiteWrap = document.getElementById(prefix+"White");
      const blackWrap = document.getElementById(prefix+"Black");
      whiteWrap.innerHTML = ""; blackWrap.innerHTML = "";

      // 8 white keys: C D E F G A B C
      const WHITE_SEMITONES = [0,2,4,5,7,9,11,12];
      for (let i=0;i<8;i++) {
        const idx12 = WHITE_SEMITONES[i];
        const white = document.createElement('div');
        white.className = 'key white';
        white.dataset.index = idx12; // top C tagged as 12
        white.dataset.keyIndex = i;
        whiteWrap.appendChild(white);
      }

      // 5 black keys: C#, D#, F#, G#, A#
      const blackIdxs = [1,3,6,8,10];
      const innerWidth = 100;
      const whiteSlot = innerWidth / 8; // percent per white key
      const whiteBeforeMap = {1:0, 3:1, 6:3, 8:4, 10:5};
      const offsetIntoGap = whiteSlot * 0.6;

      blackIdxs.forEach((idx12) => {
        const absoluteWhiteIndex = whiteBeforeMap[idx12];
        const key = document.createElement('div');
        key.className = 'key black';
        key.dataset.index = idx12;
        key.style.left = `calc(6px + ${whiteSlot*absoluteWhiteIndex}% + ${offsetIntoGap}%)`;
        blackWrap.appendChild(key);
      });
    }

    // --- Drawing with FIXED pen thickness ---
    const FIXED_LINE_WIDTH = 5; // px
    const drawCanvas = document.getElementById('draw');
    const kbBottom = document.getElementById('kbBottom');
    const ctx = drawCanvas.getContext('2d');

    let drawing = false;

    function resizeCanvas() {
      const rect = kbBottom.getBoundingClientRect();
      const scale = window.devicePixelRatio || 1;
      drawCanvas.width = Math.floor(rect.width * scale);
      drawCanvas.height = Math.floor(rect.height * scale);
      drawCanvas.style.width = rect.width + 'px';
      drawCanvas.style.height = rect.height + 'px';
      ctx.setTransform(scale, 0, 0, scale, 0, 0);
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
    }

    function pointerDown(e){ if (currentMode === 'practice' || currentMode === 'free') { drawing = true; ctx.beginPath(); ctx.moveTo(e.offsetX, e.offsetY); ctx.strokeStyle = '#d5e1ff'; ctx.lineWidth = FIXED_LINE_WIDTH; e.currentTarget.setPointerCapture(e.pointerId); e.preventDefault(); } }
    function pointerMove(e){ if (!drawing) return; ctx.lineWidth = FIXED_LINE_WIDTH; ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); e.preventDefault(); }
    function pointerUp(e){ drawing = false; e.preventDefault(); }

    drawCanvas.addEventListener('pointerdown', pointerDown, {passive:false});
    drawCanvas.addEventListener('pointermove', pointerMove, {passive:false});
    drawCanvas.addEventListener('pointerup', pointerUp, {passive:false});
    drawCanvas.addEventListener('pointercancel', pointerUp, {passive:false});

    window.addEventListener('resize', resizeCanvas);

    // Practice logic
    const chordNameEl = document.getElementById('chordName');
    const countdownEl = document.getElementById('countdown');
    const waitRange = document.getElementById('waitSeconds');
    const waitVal = document.getElementById('waitVal');

    waitRange.addEventListener('input', () => waitVal.textContent = waitRange.value);

    let timer = null; let currentChord = null;

    function setCountdown(sec) { countdownEl.textContent = sec > 0 ? `${sec}s` : 'â€”'; }
    function startCountdown() { clearInterval(timer); let s = parseInt(waitRange.value, 10); setCountdown(s); timer = setInterval(() => { s -= 1; setCountdown(Math.max(0,s)); if (s <= 0) { clearInterval(timer); revealAnswer(); } }, 1000); }

    function getEnabledTypes(){ return [...document.querySelectorAll('#types input[type=checkbox]')].filter(c=>c.checked).map(c=>c.value); }

    function makeChord() {
      const types = getEnabledTypes(); if (types.length === 0) types.push('maj');
      const typeKey = randChoice(types); const type = CHORDS[typeKey];
      const root = Math.floor(Math.random()*12); const notes = type.intervals.map(semi => (root + semi) % 12);
      const name = `${NOTE_NAMES[root]}${type.name}`.replace('#','â™¯');
      return { root, typeKey, notes, name };
    }

    function clearHighlights(prefix='top'){
      document.querySelectorAll(`#${prefix}White .key, #${prefix}Black .key`).forEach(k => k.classList.remove('highlight'));
      document.querySelectorAll(`#kbTop .bubble`).forEach(b => b.remove());
    }

    function applyHighlights(chord) {
      clearHighlights('top');
      const targets = [...document.querySelectorAll('#topWhite .key, #topBlack .key')];
      chord.notes.forEach(n => {
        const key = targets.find(k => (parseInt(k.dataset.index,10) % 12) === n);
        if (key) { key.classList.add('highlight'); const b = document.createElement('div'); b.className = 'bubble'; b.textContent = NOTE_NAMES[n].replace('#','â™¯'); key.appendChild(b); }
      });
    }

    function newChord() { currentChord = makeChord(); chordNameEl.textContent = currentChord.name; clearHighlights('top'); startCountdown(); clearInk(); }
    function revealAnswer(){ if (!currentChord) return; applyHighlights(currentChord); setCountdown(0); }

    // Modes
    let currentMode = 'practice';
    const modePracticeBtn = document.getElementById('modePractice');
    const modeFreeBtn = document.getElementById('modeFreeDraw');
    const modeHint = document.getElementById('modeHint');

    function setMode(mode){
      currentMode = mode; const practice = mode === 'practice';
      modePracticeBtn.setAttribute('aria-pressed', practice);
      modeFreeBtn.setAttribute('aria-pressed', !practice);
      document.getElementById('newChord').disabled = !practice;
      document.getElementById('showAnswer').disabled = !practice;
      waitRange.disabled = !practice;
      document.querySelectorAll('#types input').forEach(i => i.disabled = !practice);
      if (practice) { modeHint.textContent = 'Write the three note names on the bottom keyboard.'; }
      else { clearInterval(timer); setCountdown(0); chordNameEl.textContent = 'â€”'; clearHighlights('top'); modeHint.textContent = 'Freeâ€‘draw on the bottom keyboard. Tap Clear to erase.'; }
    }

    modePracticeBtn.addEventListener('click', () => setMode('practice'));
    modeFreeBtn.addEventListener('click', () => setMode('free'));

    document.getElementById('newChord').addEventListener('click', newChord);
    document.getElementById('showAnswer').addEventListener('click', revealAnswer);
    document.getElementById('clearInk').addEventListener('click', clearInk);

    function clearInk(){ ctx.clearRect(0,0,drawCanvas.width, drawCanvas.height); }

    // Init
    buildKeyboards(); setMode('practice'); newChord();
    document.addEventListener('gesturestart', e=> e.preventDefault());
    // Block double-tap to zoom / select
    document.addEventListener('dblclick', (e) => { e.preventDefault(); }, { passive:false });
  </script>
</body>
</html>
